<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Torneos</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    
    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles-common.css">
    <link rel="stylesheet" href="css/styles-tournaments.css">
    <link rel="stylesheet" href="css/styles-registro.css">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Verificar sesi√≥n -->
    <script>
        if (!sessionStorage.getItem('xisco_session_active')) {
            window.location.href = 'index.html';
        }
    </script>
</head>
<body>
    <!-- Header con Logo y Men√∫ -->
    <div class="top-header">
        <div class="header-content">
            <a href="registro-partidos.html" class="logo">
             <div class="logo-icon">
   <img src="/pool/images/poollogo.svg" width="190px"alt="PoolFlow tracker">               
			 </div>
			 </a>
            <nav class="desktop-nav">
                <a href="registro-partidos.html" class="nav-link">Registro</a>
                <a href="estadisticas.html" class="nav-link">Estad√≠sticas</a>
				<a href="estadisticas.html#historial" class="nav-link">Historial</a>
                <a href="torneos.html" class="nav-link active">Torneos</a>
				<a href="torneos.html#analisis" class="nav-link">An√°lisis</a>
                <a href="config-github.html" class="nav-link">Sincronizaci√≥n</a>
                <a href="#" class="nav-link danger" onclick="resetAllData(); return false;">Reiniciar</a>
                <a href="#" class="nav-link" onclick="logout(); return false;">Salir</a>
            </nav>

            <div class="hamburger" onclick="toggleMenu()">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>

    <!-- Overlay del men√∫ m√≥vil -->
    <div class="mobile-menu-overlay"></div>

    <!-- Men√∫ lateral m√≥vil -->
    <div class="mobile-menu">
        <nav class="mobile-nav">
            <a href="registro-partidos.html" class="nav-link">Registro</a>
            <a href="estadisticas.html" class="nav-link">Estad√≠sticas</a>
			<a href="estadisticas.html#historial" class="nav-link">Historial</a>
            <a href="torneos.html" class="nav-link active">Torneos</a>
            <a href="config-github.html" class="nav-link">Configuraci√≥n</a>
            <a href="#" class="nav-link danger" onclick="resetAllData(); return false;">Reiniciar Datos</a>
            <a href="#" class="nav-link" onclick="logout(); return false;">Cerrar Sesi√≥n</a>
        </nav>
    </div>

    <div class="container">
        <header>
            <h1>Torneos</h1>
            <p class="subtitle">Gestiona tus competiciones y circuitos</p>
        </header>

        <!-- Estad√≠sticas Globales -->
        <div class="stats-overview" id="statsOverview"></div>

        <!-- Gr√°ficos Anal√≠ticos -->
        <!-- Filtros -->
        <div class="export-section">
          <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 12px;"> ‚òÅÔ∏è Sincronizaci√≥n con GitHub </h3>
          <p style="color: #86868b; font-size: 0.95rem; margin-bottom: 16px;"> Guarda tus datos en la nube para acceder desde cualquier dispositivo </p>
          <div class="export-buttons">
            <button class="btn-secondary" onclick="syncToGitHub()" title="Subir a GitHub"> ‚Üë Guardar cambios </button>
            <button class="btn-secondary" onclick="loadFromGitHub()" title="Descargar de GitHub"> ‚Üì Cargar datos </button>
            <button class="btn-secondary"  onclick="location.reload()"  title="Refrescar p√°gina"> ‚ü≥ Refrescar</button>
            <button class="btn-secondary" onclick="exportToJSON()"> ‚Üì Exportar JSON </button>
            <button class="btn-secondary" onclick="exportToCSV()"> ‚ÜìExportar CSV </button>
          </div>
        </div>
        <div class="filters-bar">
            <div class="filter-group">
                <label class="filter-label">A√±o</label>
                <select class="filter-select" id="filterYear" onchange="applyFilters()">
                    <option value="">Todos los a√±os</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Modalidad</label>
                <select class="filter-select" id="filterModality" onchange="applyFilters()">
                    <option value="">Todas las modalidades</option>
                    <option value="Bola 8">Bola 8</option>
                    <option value="Bola 9">Bola 9</option>
                    <option value="Bola 10">Bola 10</option>
                    <option value="14.1 Continuo">14.1 Continuo</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Circuito</label>
                <select class="filter-select" id="filterCircuit" onchange="applyFilters()">
                    <option value="">Todos los circuitos</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">Resultado</label>
                <select class="filter-select" id="filterResult" onchange="applyFilters()">
                    <option value="">Todos los resultados</option>
                    <option value="Campe√≥n">Campe√≥n</option>
                    <option value="Subcampe√≥n">Subcampe√≥n</option>
                    <option value="Semifinales">Semifinales</option>
                    <option value="Cuartos de Final">Cuartos de Final</option>
                </select>
            </div>
            <button class="filter-reset" onclick="resetFilters()">Limpiar filtros</button>
        </div>

        <!-- Tabs de Navegaci√≥n -->
        <div class="section">
            <div class="button-group" style="margin-bottom: 32px;">
                <button class="btn btn-secondary" onclick="showSection('tournaments')">
                    üèÜ Mis Torneos
                </button>
                <button class="btn btn-secondary" onclick="showSection('circuits')">
                    Circuitos
                </button>
               
            </div>
        </div>

        <!-- Secci√≥n: Lista de Torneos -->
      <div id="tournamentsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Mis Torneos</h2>
                <p class="section-description">Historial completo de competiciones</p>
            </div>
 			<button class="btn btn-secondary" onclick="showSection('add')">
                    + Nuevo Torneo
                </button>
            <div id="tournamentsGrid" class="tournaments-grid"></div>
		
<!-- Paginaci√≥n -->
<div id="tournamentsPagination" class="pagination-container" style="display: none;"></div>

<!-- Estado vac√≠o -->
 <div id="emptyTournaments" class="empty-state" style="display: none;">
                <div class="empty-state-icon">üèÜ</div>
                <h3 class="empty-state-title">No hay torneos en esta selecci√≥n.</h3>
                <p class="empty-state-description">
                    Comienza a registrar tus competiciones para llevar un seguimiento completo
                </p>
                <button class="btn btn-primary" onclick="showSection('add')">
                    + A√±adir Torneo
                </button>
            </div>
        </div>


        <!-- Secci√≥n: Circuitos -->
        <div id="circuitsSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Circuitos</h2>
                <p class="section-description">Tus rankings en diferentes circuitos</p>
            </div>

            <div style="margin-bottom: 24px;">
                <button class="btn btn-secondary" onclick="showAddCircuitModal()">
                    + Nuevo Circuito
                </button>
            </div>

            <div id="circuitsGrid" class="circuits-grid"></div>

            <!-- Estado vac√≠o -->
            <div id="emptyCircuits" class="empty-state" style="display: none;">
                <div class="empty-state-icon"></div>
                <h3 class="empty-state-title">...</h3>
                <p class="empty-state-description">
                    Crea circuitos para agrupar torneos y calcular rankings
                </p>
                <button class="btn btn-primary" onclick="showAddCircuitModal()">
                    + Crear Circuito
                </button>
            </div>
        </div>

        <!-- Secci√≥n: A√±adir Torneo -->
        <div id="addTournamentSection" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">Nuevo Torneo</h2>
                <p class="section-description">Registra los detalles de tu competici√≥n</p>
            </div>

            <div class="tournament-form-card">
                <form id="tournamentForm" onsubmit="saveTournament(event)">
                    <!-- Informaci√≥n B√°sica -->
                    <div class="form-section">
                        <h3 class="form-section-title">Informaci√≥n B√°sica</h3>
                        <div class="form-grid">
                            <div class="form-group form-group-full">
                                <label>Nombre del Torneo <span class="required">*</span></label>
                                <input type="text" id="tournamentName" required 
                                       placeholder="Ej: Copa Ciudad 2024">
                            </div>
                            
                            <div class="form-group">
                                <label>Fecha <span class="required">*</span></label>
                                <input type="date" id="tournamentDate" required>
                            </div>
                            
                            <div class="form-group">
                                <label>Modalidad <span class="required">*</span></label>
                                <select id="tournamentModality" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Bola 8">Bola 8</option>
                                    <option value="Bola 9">Bola 9</option>
                                    <option value="Bola 10">Bola 10</option>
                                    <option value="14.1 Continuo">14.1 Continuo</option>
                                    <option value="Banco Pool">Banco Pool</option>
                                    <option value="One Pocket">One Pocket</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Total de Jugadores</label>
                                <input type="number" id="tournamentPlayers" min="2" 
                                       placeholder="Ej: 32">
                            </div>
                            
                            <div class="form-group">
                                <label>Resultado <span class="required">*</span></label>
                                <select id="tournamentResult" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="Campe√≥n">ü•á Campe√≥n</option>
                                    <option value="Subcampe√≥n">ü•à Subcampe√≥n</option>
                                    <option value="Semifinales">ü•â Semifinales</option>
                                    <option value="Cuartos de Final">5¬∫</option>
                                    <option value="Octavos de Final">9¬∫</option>
                                    <option value="Dieciseisavos">16¬∫</option>
                                    <option value="Fase de Grupos">Fase de Grupos</option>
                                    <option value="Eliminado en Ronda 1">Eliminado en Ronda 1</option>
                                    <option value="Participaci√≥n">Participaci√≥n</option>
                                </select>
                            </div>
                        </div>
                    </div>
					

                    <!-- Detalles Adicionales -->
                    <div class="form-section">
                        <h3 class="form-section-title">üìù Detalles Adicionales</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Circuito</label>
                                <select id="tournamentCircuit">
                                    <option value="">Sin circuito</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Taco Usado</label>
                                <select id="tournamentCue">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label>Rival de la √öltima Ronda</label>
                                <input type="text" id="tournamentRival" 
                                       placeholder="Nombre del rival final">
                            </div>
                            
                            <div class="form-group form-group-full">
                                <label>Notas</label>
                                <textarea id="tournamentNotes" rows="3" 
                                          style="resize: vertical; font-family: inherit; padding: 14px 16px; border: 1.5px solid rgba(0, 0, 0, 0.15); border-radius: 12px; font-size: 1rem;"
                                          placeholder="Notas adicionales sobre el torneo..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Estad√≠sticas del Torneo (Opcional) -->
                    <div class="form-section">
                        <h3 class="form-section-title">üìä Estad√≠sticas (Opcional)</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Partidos Jugados</label>
                                <input type="number" id="tournamentMatchesPlayed" min="0" 
                                       placeholder="0">
                            </div>
                            
                            <div class="form-group">
                                <label>Partidos Ganados</label>
                                <input type="number" id="tournamentMatchesWon" min="0" 
                                       placeholder="0">
                            </div>
                            
                            <div class="form-group">
                                <label>Partidas Ganadas</label>
                                <input type="number" id="tournamentGamesWon" min="0" 
                                       placeholder="0">
                            </div>
                            
                            <div class="form-group">
                                <label>Partidas Perdidas</label>
                                <input type="number" id="tournamentGamesLost" min="0" 
                                       placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="button-group">
                        <button type="submit" class="btn-secondary">
                            Guardar Torneo
                        </button>
                        <button type="button" class="btn-secondary" onclick="cancelEditTournament()">
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>

		 <div class="export-section">
          <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 12px;"> ‚òÅÔ∏è Sincronizaci√≥n con GitHub </h3>
          <p style="color: #86868b; font-size: 0.95rem; margin-bottom: 16px;"> Guarda tus datos en la nube para acceder desde cualquier dispositivo </p>
          <div class="export-buttons">
            <button class="btn-secondary" onclick="syncToGitHub()" title="Subir a GitHub"> ‚Üë Guardar cambios </button>
            <button class="btn-secondary" onclick="loadFromGitHub()" title="Descargar de GitHub"> ‚Üì Cargar datos </button>
            <button class="btn-secondary"  onclick="location.reload()"  title="Refrescar p√°gina"> ‚ü≥ Refrescar</button>
            <button class="btn-secondary" onclick="exportToJSON()"> ‚Üì Exportar JSON </button>
            <button class="btn-secondary" onclick="exportToCSV()"> ‚ÜìExportar CSV </button>
          </div>
        </div>

		
        <!-- Secci√≥n de Exportaci√≥n y Sincronizaci√≥n -->
        <div class="analytics-section">
          <div class="section-header" id="analisis">
            <h2 class="section-title" >An√°lisis Detallado</h2>
            <p class="section-description">Visualiza tu rendimiento con gr√°ficos interactivos</p>
          </div>
          <div class="charts-grid">
            <!-- Gr√°fico: Resultados por A√±o -->
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Resultados por A√±o</h3>
                <p class="chart-description">Evoluci√≥n de tus logros en el tiempo</p>
              </div>
              <div class="chart-container">
                <canvas id="yearResultsChart"></canvas>
              </div>
            </div>
            <!-- Gr√°fico: Rendimiento por Material -->
            <div class="chart-card">
              <div class="chart-header">
                <h3 class="chart-title">Rendimiento por Taco</h3>
                <p class="chart-description">¬øQu√© material te da mejores resultados?</p>
              </div>
              <div class="chart-container">
                <canvas id="materialPerformanceChart"></canvas>
              </div>
            </div>
            <!-- Gr√°fico: Evoluci√≥n Temporal -->
            <div class="chart-card chart-card-wide">
              <div class="chart-header">
                <h3 class="chart-title">Evoluci√≥n Temporal</h3>
                <p class="chart-description">L√≠nea de tiempo de tus torneos</p>
              </div>
              <div class="chart-container">
                <canvas id="timelineChart"></canvas>
              </div>
            </div>
          </div>
        </div>

<!-- ============================================ -->
<!-- NUEVA SECCI√ìN: COMPARATIVA DE CIRCUITOS -->
<!-- A√±adir esto en la secci√≥n de estad√≠sticas -->
<!-- ============================================ -->

<div class="card">
    <div class="card-header">
        <h2>üìä Comparativa de Circuitos</h2>
        <p class="card-subtitle">Compara el rendimiento entre diferentes circuitos</p>
    </div>
    
    <div class="card-body">
        <!-- Selector de circuitos -->
        <div class="circuit-selector-container">
            <div class="selector-header">
                <span class="selector-label">Selecciona circuitos para comparar:</span>
                <button class="btn-secondary btn-small" onclick="selectAllCircuits()">
                    Seleccionar todos
                </button>
                <button class="btn-secondary btn-small" onclick="clearCircuitSelection()">
                    Limpiar selecci√≥n
                </button>
            </div>
            
            <div id="circuitCheckboxes" class="circuit-checkboxes">
                <!-- Se llenar√° din√°micamente con JavaScript -->
            </div>
            
            <div class="no-circuits" id="noCircuitsMessage" style="display: none;">
                <p>‚ö†Ô∏è No hay circuitos para comparar. A√±ade circuitos a tus torneos primero.</p>
            </div>
        </div>
        
        <!-- Selector de m√©trica -->
        <div class="metric-selector">
            <label for="comparisonMetric">Comparar por:</label>
            <select id="comparisonMetric" onchange="updateCircuitComparison()">
                <option value="tournaments">N√∫mero de torneos</option>
                <option value="winRate">Tasa de victoria (%)</option>
                <option value="avgPosition">Posici√≥n promedio</option>
                <option value="totalMatches">Total de partidas</option>
                <option value="totalWins">Total de victorias</option>
            </select>
        </div>
        
        <!-- Gr√°fica -->
        <div class="chart-container">
            <canvas id="circuitComparisonChart"></canvas>
        </div>
        
        <!-- Tabla comparativa -->
        <div class="comparison-table-container">
            <h3>Detalles por circuito</h3>
            <div class="table-responsive">
                <table id="circuitComparisonTable" class="comparison-table">
                    <thead>
                        <tr>
                            <th>Circuito</th>
                            <th>Torneos</th>
                            <th>Victorias</th>
                            <th>% Victoria</th>
                            <th>Pos. Media</th>
                            <th>Mejor Pos.</th>
                            <th>√öltima participaci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="circuitComparisonTableBody">
                        <!-- Se llenar√° din√°micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ============================================ -->
<!-- ESTILOS CSS -->
<!-- A√±adir en la secci√≥n <style> -->
<!-- ============================================ -->

<style>
/* Contenedor del selector de circuitos */
.circuit-selector-container {
    margin-bottom: 24px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
}

.selector-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
}

.selector-label {
    font-weight: 600;
    color: #1d1d1f;
    font-size: 15px;
    flex: 1;
    min-width: 200px;
}

.btn-small {
    padding: 6px 12px;
    font-size: 13px;
}

/* Checkboxes de circuitos */
.circuit-checkboxes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
}

.circuit-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

.circuit-checkbox:hover {
    border-color: #3b82f6;
    background: #f0f9ff;
}

.circuit-checkbox.selected {
    border-color: #3b82f6;
    background: #dbeafe;
}

.circuit-checkbox input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #3b82f6;
}

.circuit-checkbox label {
    cursor: pointer;
    font-size: 14px;
    color: #1d1d1f;
    font-weight: 500;
    margin: 0;
    flex: 1;
}

.circuit-checkbox .circuit-count {
    font-size: 12px;
    color: #86868b;
    background: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-weight: 600;
}

.circuit-checkbox.selected .circuit-count {
    background: #3b82f6;
    color: white;
}

/* Mensaje sin circuitos */
.no-circuits {
    text-align: center;
    padding: 40px 20px;
    color: #86868b;
}

.no-circuits p {
    font-size: 15px;
    margin: 0;
}

/* Selector de m√©trica */
.metric-selector {
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.metric-selector label {
    font-weight: 600;
    color: #1d1d1f;
    font-size: 14px;
}

.metric-selector select {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    background: white;
    cursor: pointer;
    min-width: 200px;
}

/* Contenedor de la gr√°fica */
.chart-container {
    position: relative;
    height: 400px;
    margin-bottom: 32px;
    background: white;
    padding: 20px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}

/* Tabla comparativa */
.comparison-table-container {
    margin-top: 24px;
}

.comparison-table-container h3 {
    font-size: 18px;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 16px;
}

.table-responsive {
    overflow-x: auto;
}

.comparison-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.comparison-table thead {
    background: #f8f9fa;
}

.comparison-table th {
    padding: 12px 16px;
    text-align: left;
    font-size: 13px;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid #e5e7eb;
}

.comparison-table tbody tr {
    border-bottom: 1px solid #f3f4f6;
    transition: background 0.2s;
}

.comparison-table tbody tr:hover {
    background: #f9fafb;
}

.comparison-table tbody tr:last-child {
    border-bottom: none;
}

.comparison-table td {
    padding: 12px 16px;
    font-size: 14px;
    color: #1d1d1f;
}

.comparison-table .circuit-name {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.comparison-table .circuit-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
    flex-shrink: 0;
}

.comparison-table .metric-value {
    font-weight: 600;
}

.comparison-table .positive {
    color: #10b981;
}

.comparison-table .negative {
    color: #ef4444;
}

.comparison-table .neutral {
    color: #86868b;
}

/* Responsive */
@media (max-width: 768px) {
    .circuit-checkboxes {
        grid-template-columns: 1fr;
    }
    
    .selector-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .btn-small {
        width: 100%;
    }
    
    .metric-selector {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .metric-selector select {
        width: 100%;
    }
    
    .chart-container {
        height: 300px;
    }
}
</style>

<!-- ============================================ -->
<!-- JAVASCRIPT -->
<!-- A√±adir al final del archivo, antes de </body> -->
<!-- ============================================ -->

<script>
<!-- ============================================ -->
<!-- COMPARATIVA DE CIRCUITOS - VERSI√ìN CORREGIDA -->
<!-- Con nombres reales y gr√°fica de l√≠neas -->
<!-- ============================================ -->

<script>
// ============================================
// VARIABLES GLOBALES PARA COMPARATIVA
// ============================================

let circuitComparisonChart = null;
let selectedCircuits = new Set();
const circuitColors = [
    '#3b82f6', // Azul
    '#ef4444', // Rojo
    '#10b981', // Verde
    '#f59e0b', // Amarillo
    '#8b5cf6', // P√∫rpura
    '#ec4899', // Rosa
    '#14b8a6', // Turquesa
    '#f97316', // Naranja
    '#6366f1', // √çndigo
    '#84cc16', // Lima
];

// ============================================
// FUNCI√ìN PARA OBTENER NOMBRE REAL DEL CIRCUITO
// ============================================

function getCircuitName(circuitId) {
    if (!circuitId) return 'Sin circuito';
    
    // Si es un ID (empieza con "circuit_"), buscar el nombre real
    if (circuitId.startsWith('circuit_')) {
        // Buscar en la lista de circuitos
        if (matchesData.circuits && Array.isArray(matchesData.circuits)) {
            const circuit = matchesData.circuits.find(c => c.id === circuitId);
            if (circuit && circuit.name) {
                return circuit.name;
            }
        }
        
        // Si no se encuentra, intentar obtener de los torneos
        const tournament = matchesData.tournaments.find(t => t.circuit === circuitId);
        if (tournament && tournament.circuitName) {
            return tournament.circuitName;
        }
        
        // Si a√∫n no se encuentra, retornar un nombre m√°s legible
        return circuitId.replace('circuit_', 'Circuito #').substring(0, 20);
    }
    
    // Si no es un ID, retornar tal cual (es el nombre)
    return circuitId;
}

// ============================================
// INICIALIZAR COMPARATIVA DE CIRCUITOS
// ============================================

function initCircuitComparison() {
    console.log('üîÑ Inicializando comparativa de circuitos...');
    
    // Obtener circuitos √∫nicos de los torneos
    const circuits = getCircuitsFromTournaments();
    
    if (circuits.length === 0) {
        document.getElementById('circuitCheckboxes').style.display = 'none';
        document.getElementById('noCircuitsMessage').style.display = 'block';
        return;
    }
    
    document.getElementById('circuitCheckboxes').style.display = 'grid';
    document.getElementById('noCircuitsMessage').style.display = 'none';
    
    // Crear checkboxes
    renderCircuitCheckboxes(circuits);
    
    // Seleccionar todos por defecto (m√°ximo 5)
    const circuitsToSelect = circuits.slice(0, 5);
    circuitsToSelect.forEach(circuit => selectedCircuits.add(circuit.id));
    
    // Actualizar UI
    updateCheckboxStates();
    
    // Renderizar gr√°fica
    updateCircuitComparison();
}

// ============================================
// OBTENER CIRCUITOS DE TORNEOS
// ============================================

function getCircuitsFromTournaments() {
    const circuitMap = new Map();
    
    matchesData.tournaments.forEach(tournament => {
        if (tournament.circuit && tournament.circuit.trim() !== '') {
            const circuitId = tournament.circuit.trim();
            const circuitName = getCircuitName(circuitId);
            
            if (!circuitMap.has(circuitId)) {
                circuitMap.set(circuitId, {
                    id: circuitId,           // ID original (circuit_xxxxx)
                    name: circuitName,       // Nombre legible
                    count: 0,
                    tournaments: []
                });
            }
            
            const circuit = circuitMap.get(circuitId);
            circuit.count++;
            circuit.tournaments.push(tournament);
        }
    });
    
    // Convertir a array y ordenar por cantidad de torneos
    return Array.from(circuitMap.values())
        .sort((a, b) => b.count - a.count);
}

// ============================================
// RENDERIZAR CHECKBOXES
// ============================================

function renderCircuitCheckboxes(circuits) {
    const container = document.getElementById('circuitCheckboxes');
    
    container.innerHTML = circuits.map((circuit, index) => `
        <div class="circuit-checkbox ${selectedCircuits.has(circuit.id) ? 'selected' : ''}" 
             onclick="toggleCircuitSelection('${escapeHtml(circuit.id)}')">
            <input 
                type="checkbox" 
                id="circuit_${index}"
                ${selectedCircuits.has(circuit.id) ? 'checked' : ''}
                onchange="toggleCircuitSelection('${escapeHtml(circuit.id)}')"
                onclick="event.stopPropagation()">
            <label for="circuit_${index}">${escapeHtml(circuit.name)}</label>
            <span class="circuit-count">${circuit.count}</span>
        </div>
    `).join('');
}

// ============================================
// TOGGLE SELECCI√ìN DE CIRCUITO
// ============================================

function toggleCircuitSelection(circuitId) {
    if (selectedCircuits.has(circuitId)) {
        selectedCircuits.delete(circuitId);
    } else {
        selectedCircuits.add(circuitId);
    }
    
    updateCheckboxStates();
    updateCircuitComparison();
}

// ============================================
// ACTUALIZAR ESTADOS DE CHECKBOXES
// ============================================

function updateCheckboxStates() {
    const circuits = getCircuitsFromTournaments();
    const checkboxes = document.querySelectorAll('.circuit-checkbox');
    
    checkboxes.forEach((checkbox, index) => {
        const circuit = circuits[index];
        if (!circuit) return;
        
        const input = checkbox.querySelector('input[type="checkbox"]');
        
        if (selectedCircuits.has(circuit.id)) {
            checkbox.classList.add('selected');
            input.checked = true;
        } else {
            checkbox.classList.remove('selected');
            input.checked = false;
        }
    });
}

// ============================================
// SELECCIONAR TODOS LOS CIRCUITOS
// ============================================

function selectAllCircuits() {
    const circuits = getCircuitsFromTournaments();
    selectedCircuits.clear();
    circuits.forEach(circuit => selectedCircuits.add(circuit.id));
    updateCheckboxStates();
    updateCircuitComparison();
}

// ============================================
// LIMPIAR SELECCI√ìN
// ============================================

function clearCircuitSelection() {
    selectedCircuits.clear();
    updateCheckboxStates();
    updateCircuitComparison();
}

// ============================================
// ACTUALIZAR COMPARATIVA
// ============================================

function updateCircuitComparison() {
    if (selectedCircuits.size === 0) {
        destroyCircuitChart();
        document.getElementById('circuitComparisonTableBody').innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #86868b; padding: 40px;">
                    Selecciona al menos un circuito para ver la comparativa
                </td>
            </tr>
        `;
        return;
    }
    
    const metric = document.getElementById('comparisonMetric').value;
    const circuitsData = calculateCircuitStats();
    
    renderCircuitChart(circuitsData, metric);
    renderCircuitTable(circuitsData);
}

// ============================================
// CALCULAR ESTAD√çSTICAS DE CIRCUITOS
// ============================================

function calculateCircuitStats() {
    const stats = [];
    const circuits = getCircuitsFromTournaments();
    
    selectedCircuits.forEach(circuitId => {
        const circuit = circuits.find(c => c.id === circuitId);
        if (!circuit) return;
        
        const tournaments = matchesData.tournaments.filter(t => t.circuit === circuitId);
        
        if (tournaments.length === 0) return;
        
        // Calcular estad√≠sticas
        const totalTournaments = tournaments.length;
        const totalWins = tournaments.filter(t => t.result === '1¬∫' || t.result === '1').length;
        const winRate = totalTournaments > 0 ? (totalWins / totalTournaments * 100) : 0;
        
        // Calcular total de partidas
        let totalMatches = 0;
        tournaments.forEach(t => {
            if (t.stats && t.stats.victorias !== undefined && t.stats.derrotas !== undefined) {
                totalMatches += t.stats.victorias + t.stats.derrotas;
            }
        });
        
        // Calcular posici√≥n promedio
        const positions = tournaments
            .map(t => {
                const result = t.result;
                if (!result) return null;
                const match = result.match(/\d+/);
                return match ? parseInt(match[0]) : null;
            })
            .filter(p => p !== null);
        
        const avgPosition = positions.length > 0 
            ? positions.reduce((a, b) => a + b, 0) / positions.length 
            : 0;
        
        const bestPosition = positions.length > 0 ? Math.min(...positions) : 0;
        
        // √öltima participaci√≥n
        const sortedTournaments = tournaments.sort((a, b) => new Date(b.date) - new Date(a.date));
        const lastDate = sortedTournaments[0]?.date || '';
        
        stats.push({
            id: circuitId,
            name: circuit.name,  // Nombre legible
            tournaments: totalTournaments,
            wins: totalWins,
            winRate: winRate,
            avgPosition: avgPosition,
            bestPosition: bestPosition,
            totalMatches: totalMatches,
            lastDate: lastDate
        });
    });
    
    return stats;
}

// ============================================
// RENDERIZAR GR√ÅFICA DE CIRCUITOS (L√çNEAS)
// ============================================

function renderCircuitChart(circuitsData, metric) {
    const ctx = document.getElementById('circuitComparisonChart');
    
    if (!ctx) {
        console.error('Canvas no encontrado');
        return;
    }
    
    // Destruir gr√°fica anterior
    destroyCircuitChart();
    
    // Preparar datos seg√∫n la m√©trica
    let labels = circuitsData.map(c => c.name);
    let data, label, yAxisLabel;
    
    switch(metric) {
        case 'tournaments':
            data = circuitsData.map(c => c.tournaments);
            label = 'N√∫mero de Torneos';
            yAxisLabel = 'Torneos';
            break;
        case 'winRate':
            data = circuitsData.map(c => c.winRate.toFixed(1));
            label = 'Tasa de Victoria (%)';
            yAxisLabel = 'Porcentaje (%)';
            break;
        case 'avgPosition':
            data = circuitsData.map(c => c.avgPosition > 0 ? c.avgPosition.toFixed(1) : 0);
            label = 'Posici√≥n Promedio';
            yAxisLabel = 'Posici√≥n';
            break;
        case 'totalMatches':
            data = circuitsData.map(c => c.totalMatches);
            label = 'Total de Partidas';
            yAxisLabel = 'Partidas';
            break;
        case 'totalWins':
            data = circuitsData.map(c => c.wins);
            label = 'Total de Victorias';
            yAxisLabel = 'Victorias';
            break;
    }
    
    // Crear datasets con l√≠neas separadas por circuito
    const datasets = circuitsData.map((circuit, index) => {
        const color = circuitColors[index % circuitColors.length];
        
        return {
            label: circuit.name,
            data: [data[index]], // Punto √∫nico
            borderColor: color,
            backgroundColor: color + '20',
            borderWidth: 3,
            pointRadius: 6,
            pointHoverRadius: 8,
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            tension: 0.4, // Curvas suaves
            fill: false
        };
    });
    
    // Si hay m√∫ltiples circuitos, crear l√≠nea conectada
    if (circuitsData.length > 1) {
        // Crear una sola l√≠nea que conecta todos los puntos
        const mainDataset = {
            label: label,
            data: data,
            borderColor: '#94a3b8',
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 0,
            tension: 0.4,
            fill: false
        };
        
        // Crear puntos individuales de colores
        const pointDatasets = circuitsData.map((circuit, index) => {
            const color = circuitColors[index % circuitColors.length];
            
            return {
                label: circuit.name,
                data: data.map((_, i) => i === index ? data[i] : null),
                borderColor: color,
                backgroundColor: color,
                borderWidth: 3,
                pointRadius: 8,
                pointHoverRadius: 10,
                pointBackgroundColor: color,
                pointBorderColor: '#fff',
                pointBorderWidth: 3,
                tension: 0.4,
                fill: false,
                showLine: false // Solo puntos, sin l√≠nea
            };
        });
        
        // Crear gr√°fica con l√≠nea base y puntos de colores
        circuitComparisonChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [mainDataset, ...pointDatasets]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'point',
                    intersect: true
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            font: {
                                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',
                                size: 12,
                                weight: '500'
                            },
                            padding: 16,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            filter: function(item, chart) {
                                // No mostrar la l√≠nea base en la leyenda
                                return item.text !== label;
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: '600'
                        },
                        bodyFont: {
                            size: 13
                        },
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.label === label) return null;
                                
                                let labelText = context.dataset.label || '';
                                if (labelText) {
                                    labelText += ': ';
                                }
                                labelText += context.parsed.y;
                                if (metric === 'winRate') {
                                    labelText += '%';
                                } else if (metric === 'avgPosition') {
                                    labelText += '¬∫';
                                }
                                return labelText;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)',
                            drawBorder: false
                        },
                        title: {
                            display: true,
                            text: yAxisLabel,
                            font: {
                                size: 13,
                                weight: '600'
                            }
                        },
                        ticks: {
                            font: {
                                size: 12
                            },
                            padding: 8,
                            callback: function(value) {
                                if (metric === 'winRate') {
                                    return value + '%';
                                } else if (metric === 'avgPosition') {
                                    return value + '¬∫';
                                }
                                return value;
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: {
                                size: 12,
                                weight: '500'
                            },
                            padding: 8
                        }
                    }
                }
            }
        });
    } else {
        // Para un solo circuito, usar gr√°fica de barras simple
        circuitComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: circuitColors[0] + '40',
                    borderColor: circuitColors[0],
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        callbacks: {
                            label: function(context) {
                                let labelText = label + ': ' + context.parsed.y;
                                if (metric === 'winRate') {
                                    labelText += '%';
                                } else if (metric === 'avgPosition') {
                                    labelText += '¬∫';
                                }
                                return labelText;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        title: {
                            display: true,
                            text: yAxisLabel
                        }
                    }
                }
            }
        });
    }
}

// ============================================
// DESTRUIR GR√ÅFICA
// ============================================

function destroyCircuitChart() {
    if (circuitComparisonChart) {
        circuitComparisonChart.destroy();
        circuitComparisonChart = null;
    }
}

// ============================================
// RENDERIZAR TABLA COMPARATIVA
// ============================================

function renderCircuitTable(circuitsData) {
    const tbody = document.getElementById('circuitComparisonTableBody');
    
    if (circuitsData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align: center; color: #86868b; padding: 40px;">
                    No hay datos para mostrar
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = circuitsData.map((circuit, index) => {
        const color = circuitColors[index % circuitColors.length];
        const winRateClass = circuit.winRate >= 50 ? 'positive' : circuit.winRate >= 30 ? 'neutral' : 'negative';
        const positionClass = circuit.avgPosition <= 3 ? 'positive' : circuit.avgPosition <= 8 ? 'neutral' : 'negative';
        
        return `
            <tr>
                <td>
                    <div class="circuit-name">
                        <div class="circuit-color" style="background-color: ${color};"></div>
                        ${escapeHtml(circuit.name)}
                    </div>
                </td>
                <td class="metric-value">${circuit.tournaments}</td>
                <td class="metric-value">${circuit.wins}</td>
                <td class="metric-value ${winRateClass}">${circuit.winRate.toFixed(1)}%</td>
                <td class="metric-value ${positionClass}">
                    ${circuit.avgPosition > 0 ? circuit.avgPosition.toFixed(1) + '¬∫' : '-'}
                </td>
                <td class="metric-value positive">
                    ${circuit.bestPosition > 0 ? circuit.bestPosition + '¬∫' : '-'}
                </td>
                <td>${circuit.lastDate ? new Date(circuit.lastDate).toLocaleDateString('es-ES') : '-'}</td>
            </tr>
        `;
    }).join('');
}

// ============================================
// FUNCI√ìN AUXILIAR: ESCAPE HTML
// ============================================

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

// ============================================
// INICIALIZAR AL CARGAR LA P√ÅGINA
// ============================================

// A√±adir a tu DOMContentLoaded existente:
document.addEventListener('DOMContentLoaded', () => {
    // ... tu c√≥digo existente ...
    
    // Inicializar comparativa de circuitos
    setTimeout(() => {
        if (typeof initCircuitComparison === 'function') {
            initCircuitComparison();
        }
    }, 500);
});

// Tambi√©n actualizar cuando cambien los datos
function updateCircuitComparisonIfVisible() {
    const comparisonChart = document.getElementById('circuitComparisonChart');
    if (comparisonChart && comparisonChart.offsetParent !== null) {
        initCircuitComparison();
    }
}

console.log('‚úÖ Comparativa de circuitos con l√≠neas cargada');
</script>

		

		
<!-- Indicador de sincronizaci√≥n -->
    <div id="syncIndicator" style="position: fixed; bottom: 20px; right: 20px; padding: 12px 20px; background: #34c759; color: white; border-radius: 12px; font-weight: 600; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 1000;">
        ‚òÅÔ∏è Sincronizado
    </div>

    <!-- JavaScript -->
    <script src="js/common.js"></script>
    <script src="js/tournaments.js"></script>
</body>
</html>

























